{% extends 'layout.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="topbar">
    <h2 class="page-title"><span class="material-icons">calendar_today</span> Dein Dashboard</h2>
    <div class="profile-dropdown">
        <!-- Benutzerprofil-Dropdown -->
    </div>
</div>

<div class="grid-container">

    <!-- Neuen Termin hinzuf√ºgen -->
    <div class="card">
        <h3>Neuen Termin hinzuf√ºgen</h3>
        <form method="POST">
            <input type="text" name="event_title" placeholder="Titel" required>
            <input type="date" name="event_date" required>

            <label for="event_repeat">Wiederholung:</label>
            <select name="event_repeat" id="event_repeat">
                <option value="none">Einmalig</option>
                <option value="daily">T√§glich</option>
                <option value="weekly">W√∂chentlich</option>
                <option value="monthly">Monatlich</option>
            </select>

            <button type="submit">+ Termin hinzuf√ºgen</button>
        </form>
    </div>

    <!-- Neue Aufgabe hinzuf√ºgen -->
    <div class="card">
        <h3>Neue Aufgabe</h3>
        <form method="POST">
            <input type="text" name="task_description" placeholder="Aufgabe" required>
        
            <label for="task_repeat">Wiederholung:</label>
            <select name="task_repeat" id="task_repeat">
                <option value="none">Einmalig</option>
                <option value="daily">T√§glich</option>
                <option value="weekly">W√∂chentlich</option>
            </select>
        
            <button type="submit">+ Aufgabe hinzuf√ºgen</button>
        </form>
    </div>

    <!-- Termine anzeigen -->
    <div class="card">
        <h3><span class="material-icons">calendar_today</span> Deine Termine</h3>
        {% if events %}
            <ul>
                {% for event in events %}
                <li>
                    <span>
                        {{ event.title }} am {{ event.date }}
                        {% if event.repeat != 'none' %}
                          <span class="material-icons" style="font-size: 16px; vertical-align: middle;" title="Wiederkehrend">autorenew</span>
                        {% endif %}
                      </span>
                      {% if event.id %}
                      <a href="/event/edit/{{ event.id }}" class="edit-link">‚úèÔ∏è</a>
                      <a href="/event/delete/{{ event.id }}" class="delete-link">üóëÔ∏è</a>
                      {% endif %}
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Keine Termine eingetragen.</p>
        {% endif %}
    </div>

    <!-- Aufgaben anzeigen -->
    <div class="card">
        <h3><span class="material-icons">checklist</span> Deine Aufgaben</h3>
        {% if tasks %}
            <ul>
                {% for task in tasks %}
                    <li>
                        {% if task.id %}
                        <form action="/task/done/{{ task.id }}" method="GET" style="display:inline;">
                            <button type="submit" style="border: none; background: none; cursor: pointer;">
                                <span class="material-icons">
                                    {{ 'check_box' if task.done else 'check_box_outline_blank' }}
                                </span>
                            </button>
                        </form>
                        {% endif %}
                        <span>
                            {{ task.description }}
                            {% if task.due_date %} ({{ task.due_date }}){% endif %}
                            {% if task.repeat != 'none' %}
                              <span class="material-icons" style="font-size: 16px; vertical-align: middle;" title="Wiederkehrend">autorenew</span>
                            {% endif %}
                        </span>
                        {% if task.id %}
                        <a href="/task/delete/{{ task.id }}" class="delete-link">üóëÔ∏è</a>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Keine Aufgaben eingetragen.</p>
        {% endif %}
    </div>

    <!-- Kalender -->
    <div class="card">
        <h3>Kalender</h3>
        <div class="calendar">
            {{ month_calendar | safe }}
        </div>
    </div>

    <!-- Export -->
    <div class="card export-card">
        <a href="/export">üì• Daten als CSV exportieren</a>
    </div>

</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}">
{% endblock %}

{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    if (calendarEl) {
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'de',
        height: 600,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,listMonth'
        },
        events: '/api/events'
      });
      calendar.render();
    }
  });
</script>
{% endblock %}